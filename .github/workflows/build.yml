###############################################################################
# GitHub Actions CI â€“ Build & Push KASM GR2Analyst Workspace Image
###############################################################################
name: Build KASM GR2Analyst Image

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      base_tag:
        description: 'KASM core image tag (e.g. develop, 1.18.0)'
        required: false
        default: 'develop'
      push_image:
        description: 'Push image to registry?'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

env:
  # â”€â”€ Registry / image config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/kasm-gr2analyst
  # â”€â”€ KASM base image tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BASE_TAG: ${{ github.event.inputs.base_tag || 'develop' }}
  BASE_IMAGE: core-ubuntu-jammy

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Lint â€“ quick sanity checks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          # DL3008 (pin versions) is noisy for Wine/Mesa packages
          # DL3003 (use WORKDIR) â€“ we do, but Hadolint false-positives
          ignore: DL3008,DL3003,DL3015,SC2086,SC2174

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build (and optionally push)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build Image
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ Free up disk space (Wine + .NET + KASM base = large layers) â”€â”€â”€â”€
      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet \
                      /opt/ghc /usr/local/share/boost || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      # â”€â”€ Docker Buildx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # â”€â”€ Login to GHCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Login to Docker Hub (optional, for wider distribution) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request' && vars.DOCKERHUB_ENABLED == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      # â”€â”€ Metadata (tags & labels) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ env.BASE_TAG }}

      # â”€â”€ Build & Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event.inputs.push_image == 'true') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BASE_TAG=${{ env.BASE_TAG }}
            BASE_IMAGE=${{ env.BASE_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€ Image size report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Report image size
        if: success()
        run: |
          echo "### ðŸ³ Image Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker images --filter "reference=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}*" \
            --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Smoke test â€“ start the container and verify GR2Analyst binary exists
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Smoke Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Pull image
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_SHA}

      - name: Verify GR2Analyst installation
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          docker run --rm \
            --entrypoint /bin/bash \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_SHA} \
            -c '
              echo "=== Checking Wine ===" &&
              wine --version &&
              echo "=== Checking GR2Analyst files ===" &&
              FOUND=0 &&
              for d in \
                "/home/kasm-default-profile/.wine/drive_c/Program Files/GRLevelX/GR2Analyst_3" \
                "/home/kasm-default-profile/.wine/drive_c/Program Files/GRLevelX/GR2Analyst_2" \
                "/home/kasm-default-profile/.wine/drive_c/Program Files/GRLevelX/GR2Analyst" \
                "/home/kasm-default-profile/.wine/drive_c/Program Files/GR2Analyst"; do
                if [ -d "$d" ]; then
                  echo "âœ“ Found install at: $d"
                  ls -la "$d/" | head -20
                  FOUND=1
                  break
                fi
              done &&
              [ "$FOUND" = "1" ] || { echo "âœ— GR2Analyst not found!"; exit 1; } &&
              echo "=== Checking color tables ===" &&
              find /home/kasm-default-profile/.wine -name "*.pal" -type f 2>/dev/null | head -10 &&
              echo "=== Checking network ===" &&
              ping -c 1 mesonet-nexrad.agron.iastate.edu || echo "(ping blocked in CI â€“ OK)" &&
              echo "=== All checks passed ==="
            '
